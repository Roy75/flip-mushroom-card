class FlipMushroomCard extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: 'open' });
    this.currentIndex = 0;
  }

  setConfig(config) {
    if (!config.entities || config.entities.length < 2) {
      throw new Error("Gebruik minstens twee entities.");
    }
    this.config = config;
    this.interval = config.interval || 3000;
  }

  set hass(hass) {
    this.hassInstance = hass;
    if (!this.rendered) {
      this.renderCard();
      this.startFlip();
      this.rendered = true;
    }
    this.updateCard();
  }

  renderCard() {
    const style = document.createElement("style");
    style.textContent = `
      ha-card {
        padding: 16px;
        border-radius: 20px;
        background: linear-gradient(135deg, var(--mushroom-card-primary-bg, #1e293b), var(--mushroom-card-secondary-bg, #334155));
        color: var(--primary-text-color);
        box-shadow: var(--ha-card-box-shadow, 0 2px 6px rgba(0,0,0,0.2));
        display: flex;
        justify-content: center;
        align-items: center;
        perspective: 800px;
      }

      .flip-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transform-style: preserve-3d;
        transition: transform 0.6s ease, opacity 0.3s ease;
      }

      .icon { font-size: 2em; margin-bottom: 8px; color: var(--mushroom-accent-color, #00bcd4); }
      .value { font-size: 1.8em; font-weight: bold; }
      .label { opacity: 0.7; font-size: 0.9em; margin-top: 4px; }
    `;

    const card = document.createElement("ha-card");
    card.innerHTML = `
      <div class="flip-wrapper">
        <ha-icon class="icon"></ha-icon>
        <div class="value"></div>
        <div class="label"></div>
      </div>
    `;

    this.shadowRoot.append(style, card);
    this.card = card;
    this.wrapper = card.querySelector(".flip-wrapper");
  }

  updateCard() {
    if (!this.hassInstance) return;
    const entityId = this.config.entities[this.currentIndex];
    const stateObj = this.hassInstance.states[entityId];
    if (!stateObj) return;

    const icon = this.wrapper.querySelector(".icon");
    const value = this.wrapper.querySelector(".value");
    const label = this.wrapper.querySelector(".label");

    icon.setAttribute(
      "icon",
      this.config.icons?.[this.currentIndex] ||
      stateObj.attributes.icon ||
      "mdi:thermometer"
    );
    value.textContent = `${stateObj.state} ${stateObj.attributes.unit_of_measurement || ''}`;
    label.textContent =
      this.config.names?.[this.currentIndex] ||
      stateObj.attributes.friendly_name ||
      entityId;
  }

  startFlip() {
    this.flipTimer = setInterval(() => {
      // Start flip: Y-as (zijwaarts)
      this.wrapper.style.transform = `rotateY(90deg)`;
      this.wrapper.style.opacity = '0.3';
      setTimeout(() => {
        this.currentIndex = (this.currentIndex + 1) % this.config.entities.length;
        this.updateCard();
        this.wrapper.style.transform = `rotateY(0deg)`;
        this.wrapper.style.opacity = '1';
      }, 300);
    }, this.interval);
  }

  disconnectedCallback() {
    if (this.flipTimer) clearInterval(this.flipTimer);
  }

  getCardSize() {
    return 2;
  }
}

customElements.define("flip-mushroom-card", FlipMushroomCard);

customElements.define("flip-mushroom-card", FlipMushroomCard);
